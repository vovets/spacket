#!/bin/sh -e

do_cleanup() {
    echo $1 trap: killing RTT server with pid $2 && kill $2
}

handler() {
    local pid=$PID
    PID=""
    [ -n "$pid" ] && do_cleanup $1 $pid
}

for reason in INT TERM EXIT; do
    trap "handler $reason" $reason
done

run_test() {
    echo "Running test..."
    true
}

echo "Flashing fw..."
${CMAKE_COMMAND} --build ${CMAKE_CURRENT_BINARY_DIR} --target ${fw_project}_flash

echo "Starting RTT server..."
${JLINK_RTT_COMMAND} >jlink_rtt.out & PID=$!

[ -n "$PID" ]

echo -n "Waiting for RTT server to connect to target"
for attempt in 1 2 3 4 5 6 7 8 9 last; do
    echo -n .
    sleep 0.1
    egrep -q -e "identified.$" jlink_rtt.out && break
done
echo

[ $attempt = last ] && echo "Failed to connect to target" && false

run_test
